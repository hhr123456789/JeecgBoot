# InfluxDB同步任务改进说明

## 问题描述
原有的InfluxDB同步任务存在以下问题：
1. 实时表（tb_equ_ele_data和tb_equ_energy_data）每次都是插入操作，导致一个module_ID有多条数据
2. 实时表应该是每个module_ID只有一条数据，当有数据变化时应该是更新操作
3. 需要通过开始值与结束值定时更新日、月、年统计表的能耗量

## 解决方案

### 1. 实时表同步逻辑优化

#### 电力数据同步（syncElectricData方法）
- **修改前**：每次都执行insert操作
- **修改后**：
  1. 先查询是否已存在该模块的数据（使用selectLatestDataByModuleId方法）
  2. 如果存在数据，进行更新操作（updateById）
  3. 如果不存在数据，进行插入操作（insert）
  4. 确保每个module_ID在实时表中只有一条数据

#### 其他能源数据同步（syncOtherEnergyData方法）
- **修改前**：每次都执行insert操作
- **修改后**：
  1. 先查询是否已存在该模块的数据（使用selectLatestDataByModuleId方法）
  2. 如果存在数据，进行更新操作（updateById）
  3. 如果不存在数据，进行插入操作（insert）
  4. 确保每个module_ID在实时表中只有一条数据

### 2. 统计表能耗计算优化

#### 日统计（syncDailyEnergyData方法）
- 通过开始值和结束值计算日能耗量
- 获取昨天00:00:00的累积值作为开始值
- 获取昨天23:59:59的累积值作为结束值
- 能耗量 = 结束值 - 开始值（如果为负数则使用结束值）

#### 月统计（syncMonthlyEnergyData方法）
- 通过开始值和结束值计算月能耗量
- 获取上月第一天00:00:00的累积值作为开始值
- 获取上月最后一天23:59:59的累积值作为结束值
- 能耗量 = 结束值 - 开始值（如果为负数则使用结束值）

#### 年统计（syncYearlyEnergyData方法）
- 通过开始值和结束值计算年能耗量
- 获取去年1月1日00:00:00的累积值作为开始值
- 获取去年12月31日23:59:59的累积值作为结束值
- 能耗量 = 结束值 - 开始值（如果为负数则使用结束值）

### 3. 定时任务配置

#### 实时数据同步和统计更新
- **频率**：每5分钟执行一次
- **Cron表达式**：`0 */5 * * * ?`
- **功能**：
  1. 从InfluxDB同步最新数据到MySQL实时表
  2. 实时更新当日、当月、当年统计表
  3. 确保统计数据的实时性

#### 日统计
- **频率**：每天凌晨1点执行
- **Cron表达式**：`0 0 1 * * ?`
- **功能**：统计前一天的能耗数据

#### 月统计
- **频率**：每月1号凌晨2点执行
- **Cron表达式**：`0 0 2 1 * ?`
- **功能**：统计上个月的能耗数据

#### 年统计
- **频率**：每年1月1日凌晨3点执行
- **Cron表达式**：`0 0 3 1 1 ?`
- **功能**：统计上一年的能耗数据

## 数据库表结构

### 实时表
- **tb_equ_ele_data**：电力实时数据表，每个module_ID只有一条记录
- **tb_equ_energy_data**：其他能源实时数据表，每个module_ID只有一条记录

### 统计表
- **tb_ep_equ_energy_daycount**：日统计表，存储每日能耗数据
- **tb_ep_equ_energy_monthcount**：月统计表，存储每月能耗数据
- **tb_ep_equ_energy_yearcount**：年统计表，存储每年能耗数据

## InfluxDB数据结构

### 时序数据格式
- **measurement**：hist（默认表名）
- **tagname**：格式为 `{module_ID}#{point_name}`，例如：`YJ0001_1411B#UA`
- **time**：时间戳
- **value**：数值
- **status**：状态（通常为1表示正常）

### 点位名称映射
#### 电力数据点位
- UA, UB, UC：三相电压
- IA, IB, IC：三相电流
- PP/P：有功功率
- QQ/Q：无功功率
- SS/S：视在功率
- PFS/PFSC：功率因数
- HZ：频率
- KWH/KWH3：电能累积值
- KVARH：无功电能累积值

#### 其他能源数据点位
- TEMPERATURE/TEMP：温度
- PRESSURE：压力
- WINKVALUE：瞬时值
- ACCUMULATEVALUE：累积值

## 测试

### 单元测试
创建了 `InfluxDBSyncJobTest.java` 测试文件，包含以下测试用例：
1. 电力数据同步更新操作测试
2. 电力数据同步插入操作测试
3. 其他能源数据同步更新操作测试
4. 其他能源数据同步插入操作测试

### 运行测试
```bash
mvn test -Dtest=InfluxDBSyncJobTest
```

## 时区处理优化

### 时区问题解决方案
1. **InfluxDB时区**：InfluxDB存储的是UTC时间
2. **系统时区**：系统使用东八区时间（UTC+8）
3. **时区转换**：
   - 查询InfluxDB时：本地时间 → UTC时间（减8小时）
   - 解析InfluxDB数据时：UTC时间 → 本地时间（加8小时）
   - 新增专用的时区转换方法：`convertToUTC()` 和 `convertToLocal()`

### 时间格式处理（已优化）
- **ISO 8601格式（带毫秒）**：`2025-07-15T09:22:12.075Z` ✅ 已修复
- **ISO 8601格式（不带毫秒）**：`2025-07-15T09:22:12Z` ✅ 支持
- **本地时间格式（带毫秒）**：`2025-07-15T09:22:12.075` ✅ 支持
- **本地时间格式（不带毫秒）**：`2025-07-15T09:22:12` ✅ 支持
- **普通格式**：`2025-07-15 09:22:12` ✅ 支持
- **自动时区调整**：解析时间时自动处理时区差异
- **备用解析机制**：多种格式尝试，确保解析成功率

## 实时统计更新

### 新增功能
1. **实时日统计**：每5分钟更新当日能耗统计
2. **实时月统计**：每5分钟更新当月能耗统计
3. **实时年统计**：每5分钟更新当年能耗统计

### 统计逻辑
- **当日统计**：当天00:00:00累积值 → 当前时间累积值
- **当月统计**：当月1日00:00:00累积值 → 当前时间累积值
- **当年统计**：当年1月1日00:00:00累积值 → 当前时间累积值

### 数据更新策略
- 如果统计记录已存在：更新能耗值、开始值、结束值
- 如果统计记录不存在：创建新的统计记录
- 确保统计数据的实时性和准确性

## 注意事项

1. **时区处理**：✅ 已优化 - 自动处理InfluxDB（UTC）和系统（东八区）的时区差异
2. **数据库分月存储**：InfluxDB按月分库存储，查询时需要确定正确的数据库名称
3. **累积值重置**：当累积值出现重置（结束值小于开始值）时，直接使用结束值作为能耗量
4. **错误处理**：所有同步操作都有异常处理，确保单个模块的错误不影响其他模块的同步
5. **日志记录**：详细的日志记录便于问题排查和监控
6. **实时性保证**：✅ 新增 - 统计表每5分钟实时更新，确保数据的实时性

## 部署建议

1. **连接检查**：确保InfluxDB和MySQL连接正常
2. **定时任务**：检查定时任务是否正确启动
3. **日志监控**：监控日志输出，确认同步任务正常执行
4. **实时表验证**：定期检查实时表数据，确保每个module_ID只有一条记录
5. **统计表验证**：验证统计表数据的准确性和实时性
6. **时区验证**：确认时间数据的时区处理是否正确
7. **性能监控**：监控每5分钟的同步任务执行时间和资源消耗

## 主要改进总结

### ✅ 已解决的问题
1. **实时表唯一性**：每个module_ID只有一条记录（更新vs插入）
2. **时区处理**：自动处理InfluxDB（UTC）和系统（东八区）时区差异
3. **统计实时性**：统计表每5分钟实时更新，不再需要等到第二天
4. **能耗计算**：通过开始值和结束值准确计算能耗量
5. **错误处理**：完善的异常处理机制
6. **时间解析问题**：✅ 新修复 - 支持InfluxDB的毫秒级时间格式（如：`2025-07-15T09:22:12.075Z`）

### 🚀 新增功能
1. **实时统计更新**：日、月、年统计表每5分钟更新
2. **智能时区转换**：自动识别和转换时区
3. **时间格式兼容**：支持多种InfluxDB时间格式
4. **详细日志记录**：便于监控和问题排查

### 📊 性能优化
1. **批量处理**：按模块批量处理数据
2. **最新数据优先**：只处理每个模块的最新数据
3. **条件查询**：只查询启用的模块
4. **异常隔离**：单个模块错误不影响其他模块
