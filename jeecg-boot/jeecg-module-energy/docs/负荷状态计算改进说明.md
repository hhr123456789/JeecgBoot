# 负荷状态计算改进说明

## 概述

本次改进将原有的基于固定电流阈值的负荷状态判断方式，升级为基于负荷率百分比的科学判断方式，符合电力行业标准。

## 改进前后对比

### 改进前（V1.0）
```java
// 使用固定电流阈值判断
if (avgCurrent <= 10A) return "低负荷";
else if (avgCurrent <= 30A) return "中负荷";  
else return "高负荷";
```

**问题**:
- ❌ 固定阈值，不考虑设备容量差异
- ❌ 同样电流对不同设备意义完全不同
- ❌ 可能产生严重误判

### 改进后（V2.0）
```java
// 基于负荷率百分比判断
负荷率 = (当前功率 / 额定功率) × 100%

if (负荷率 < 30%) return "轻载";
else if (负荷率 ≤ 80%) return "正常";
else if (负荷率 ≤ 100%) return "重载";
else return "过载";
```

**优势**:
- ✅ 科学的相对比较
- ✅ 符合电力行业标准
- ✅ 适用于各种容量设备
- ✅ 增加三相不平衡检测

## 新的判断标准

### 1. 负荷状态分类
| 负荷状态 | 负荷率范围 | 说明 |
|---------|-----------|------|
| 停机 | 三相电流均 ≤ 0.5A | 设备停止运行 |
| 接线异常 | 高压设备B相有电流 | 高压三相三线制B相应为0 |
| 三相不平衡 | 不平衡度 > 10% | 普通设备三相电流差异过大 |
| 两相不平衡 | 不平衡度 > 15% | 高压设备A、C相电流差异过大 |
| 轻载 | < 30% | 设备运行在低负荷状态 |
| 正常 | 30% ~ 80% | 设备运行在正常负荷范围 |
| 重载 | 80% ~ 100% | 设备运行在高负荷状态 |
| 过载 | > 100% | 设备超负荷运行，需要关注 |

### 2. 三相不平衡检测

#### 普通三相设备（module_type ≠ 4）:
```
不平衡度 = (最大相电流 - 最小相电流) / 平均电流 × 100%
```
当不平衡度 > 10% 时，返回"三相不平衡"状态。

#### 高压三相三线制设备（module_type = 4）:
```
不平衡度 = |A相电流 - C相电流| / ((A相电流 + C相电流) / 2) × 100%
```
- B相电流为0是正常现象
- 当不平衡度 > 15% 时，返回"两相不平衡"状态
- 当B相电流 > 0.5A 时，返回"接线异常"状态

### 3. 设备类型支持
| 设备类型 | module_type值 | 特殊处理 |
|---------|--------------|---------|
| 普通三相设备 | 其他值 | 标准三相不平衡检测 |
| 高压三相三线制 | 4 | B相为0正常，只检测A、C相平衡 |

## API 使用方法

### 推荐使用方法（基于功率，支持设备类型）
```java
String loadStatus = EnergyCalculationUtils.calculateLoadStatus(
    currentPower,  // 当前功率 (kW)
    ratedPower,    // 额定功率 (kW)  
    ia, ib, ic,    // 三相电流 (A)
    moduleType     // 设备类型 (4=高压三相三线制)
);
```

### 兼容性方法（支持设备类型）
```java
String loadStatus = EnergyCalculationUtils.calculateLoadStatus(
    ia, ib, ic,    // 三相电流 (A)
    ua, ub, uc,    // 三相电压 (V)
    moduleType     // 设备类型 (4=高压三相三线制)
);
```

### 向下兼容方法（不考虑设备类型）
```java
// 基于功率（兼容原有调用）
String loadStatus = EnergyCalculationUtils.calculateLoadStatus(
    currentPower, ratedPower, ia, ib, ic
);

// 基于电压电流（兼容原有调用）
String loadStatus = EnergyCalculationUtils.calculateLoadStatus(
    ia, ib, ic, ua, ub, uc
);
```

## 实际应用示例

### 示例1: 小型设备
- **设备**: 10kW变压器
- **当前功率**: 8kW  
- **负荷率**: 8/10 = 80%
- **判断结果**: "重载"

**对比**:
- 旧方法: 电流8A → "低负荷" ❌ (误判)
- 新方法: 负荷率80% → "重载" ✅ (正确)

### 示例2: 大型设备  
- **设备**: 1000kW变压器
- **当前功率**: 250kW
- **负荷率**: 250/1000 = 25%  
- **判断结果**: "轻载"

**对比**:
- 旧方法: 电流25A → "中负荷" ❌ (误判)
- 新方法: 负荷率25% → "轻载" ✅ (正确)

### 示例3: 高压三相三线制设备
- **设备**: 10kV高压电表 (module_type = 4)
- **A相电流**: 100A
- **B相电流**: 0A (正常，接线方式导致)
- **C相电流**: 95A
- **判断结果**: "正常"

**对比**:
- 旧方法: 三相不平衡度 = (100-0)/65*100% = 154% → "三相不平衡" ❌ (误判)
- 新方法: 识别为高压设备，A、C相不平衡度 = |100-95|/97.5*100% = 5.1% → "正常" ✅ (正确)

### 示例4: 高压设备接线异常
- **设备**: 10kV高压电表 (module_type = 4)
- **A相电流**: 80A
- **B相电流**: 15A (异常，B相不应该有电流)
- **C相电流**: 75A
- **判断结果**: "接线异常"

**说明**: 高压三相三线制设备B相应该为0，如果有电流说明接线有问题。

## 降级策略

当无法获取功率信息时，系统会自动降级使用以下策略：

1. **有电压信息**: 计算视在功率进行判断
2. **仅有电流信息**: 使用改进的电流阈值估算
3. **数据异常**: 返回"未知"状态

## 配置参数

可以通过修改工具类中的常量来调整判断阈值：

```java
private static final BigDecimal LIGHT_LOAD_THRESHOLD = new BigDecimal("30");      // 轻载阈值 30%
private static final BigDecimal NORMAL_LOAD_THRESHOLD = new BigDecimal("80");     // 正常阈值 80%  
private static final BigDecimal HEAVY_LOAD_THRESHOLD = new BigDecimal("100");     // 重载阈值 100%
private static final BigDecimal IMBALANCE_THRESHOLD = new BigDecimal("10");       // 不平衡阈值 10%
```

## 测试验证

运行测试类验证改进效果：
```bash
mvn test -Dtest=EnergyCalculationUtilsImprovedTest
```

## 注意事项

1. **数据质量**: 确保功率和电流数据的准确性
2. **额定功率**: 需要在设备档案中正确配置额定功率
3. **阈值调整**: 可根据实际业务需求调整判断阈值
4. **监控告警**: 建议对"过载"和"三相不平衡"状态设置告警

## 后续优化建议

1. **设备分类**: 针对不同类型设备（变压器、电机、照明）使用不同的判断标准
2. **历史趋势**: 结合历史数据分析负荷变化趋势
3. **温度修正**: 考虑环境温度对设备负荷能力的影响
4. **功率因数**: 在判断中考虑功率因数的影响

---

**版本**: V2.0  
**更新时间**: 2025-09-12  
**负责人**: jeecg-boot团队