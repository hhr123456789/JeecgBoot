# 高压三相三线制设备支持完成报告

## 项目概述

成功实现了基于负荷率百分比的标准判断方式，并特别针对高压三相三线制设备（tb_module.module_type = 4）进行了优化，解决了B相为0导致的误判问题。

## 核心问题解决

### ❌ 原来的问题
```
高压电表: A=100A, B=0A, C=95A
旧算法: 不平衡度 = (100-0)/65*100% = 154% → "三相不平衡" (误判)
```

### ✅ 现在的解决方案
```
高压电表 (module_type=4): A=50A, B=0A, C=48A  
新算法: 识别为高压设备，A、C相不平衡度 = |50-48|/49*100% = 4.1% → "NORMAL" (正确)
```

## 主要改进内容

### 1. 工具类改进 (`EnergyCalculationUtils.java`)

#### 新增常量定义
```java
private static final Integer MODULE_TYPE_HIGH_VOLTAGE_THREE_WIRE = 4;
private static final BigDecimal HIGH_VOLTAGE_IMBALANCE_THRESHOLD = new BigDecimal("15");
```

#### 核心方法改进
- ✅ `calculateLoadStatus()` - 支持设备类型参数
- ✅ `checkThreePhaseImbalance()` - 高压设备特殊处理
- ✅ `calculateLoadStatusByPower()` - 基于设备类型调整功率阈值
- ✅ `calculateLoadStatusByCurrentEstimate()` - 基于设备类型调整电流阈值

### 2. 高压三相三线制特殊处理逻辑

#### 三相不平衡检测
```java
if (moduleType != null && moduleType.equals(MODULE_TYPE_HIGH_VOLTAGE_THREE_WIRE)) {
    // B相为0检测
    if (ib.compareTo(new BigDecimal("0.5")) > 0) {
        return "WIRING_ERROR"; // B相不应该有电流
    }
    
    // 只检查A、C两相的平衡度
    BigDecimal avgCurrent = ia.add(ic).divide(new BigDecimal("2"), 4, RoundingMode.HALF_UP);
    BigDecimal imbalanceRate = ia.subtract(ic).abs()
                                .multiply(new BigDecimal("100"))
                                .divide(avgCurrent, 2, RoundingMode.HALF_UP);
    
    if (imbalanceRate.compareTo(HIGH_VOLTAGE_IMBALANCE_THRESHOLD) > 0) {
        return "TWO_PHASE_IMBALANCE";
    }
}
```

#### 功率计算优化
```java
if (moduleType != null && moduleType.equals(MODULE_TYPE_HIGH_VOLTAGE_THREE_WIRE)) {
    // 高压三相三线制：只使用A、C相计算
    BigDecimal avgVoltage = ua.add(uc).divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP);
    BigDecimal avgCurrent = ia.add(ic).divide(new BigDecimal("2"), 2, RoundingMode.HALF_UP);
    
    // 视在功率 = 2 * 相电压 * 相电流 / 1000
    apparentPower = new BigDecimal("2")
            .multiply(avgVoltage)
            .multiply(avgCurrent)
            .divide(new BigDecimal("1000"), 2, RoundingMode.HALF_UP);
}
```

### 3. Service层更新 (`EnergyMonitorServiceImpl.java`)

```java
// 传递设备类型参数
String loadStatus = EnergyCalculationUtils.calculateLoadStatus(
    eleData.getPp(), ratedPower, 
    eleData.getIA(), eleData.getIB(), eleData.getIC(),
    module.getModuleType()  // 关键：传递设备类型
);
```

## 新的判断标准

### 设备类型识别
| 设备类型 | module_type | B相电流 | 检测逻辑 | 不平衡阈值 |
|---------|------------|---------|---------|-----------|
| 普通三相设备 | ≠ 4 | 正常有电流 | 三相不平衡检测 | 10% |
| 高压三相三线制 | = 4 | 应该为0 | 两相不平衡检测 | 15% |

### 负荷状态分类
| 负荷状态 | 负荷率范围 | 英文标识 | 说明 |
|---------|-----------|---------|------|
| 轻载 | < 30% | LIGHT_LOAD | 运行效率可能偏低 |
| 正常 | 30% - 80% | NORMAL | 理想运行状态 |
| 重载 | 80% - 100% | HEAVY_LOAD | 需要关注 |
| 过载 | > 100% | OVERLOAD | 需要立即处理 |

### 特殊状态检测
| 状态 | 英文标识 | 检测条件 |
|------|---------|---------|
| 停机 | STOPPED | 三相电流均 ≤ 0.5A |
| 接线异常 | WIRING_ERROR | 高压设备B相电流 > 0.5A |
| 两相不平衡 | TWO_PHASE_IMBALANCE | 高压设备A、C相不平衡度 > 15% |
| 三相不平衡 | THREE_PHASE_IMBALANCE | 普通设备三相不平衡度 > 10% |

## 功率阈值调整

### 高压设备阈值 (module_type = 4)
- **轻载**: ≤ 500kVA
- **正常**: 500kVA - 2000kVA
- **重载**: 2000kVA - 5000kVA
- **过载**: > 5000kVA

### 普通设备阈值 (其他 module_type)
- **轻载**: ≤ 10kVA
- **正常**: 10kVA - 50kVA
- **重载**: 50kVA - 100kVA
- **过载**: > 100kVA

## 测试验证结果

### ✅ 测试1: 高压三相三线制系统
```
输入: IA=50A, IB=0A, IC=48A, UA=10000V, ModuleType=4
结果: NORMAL
预期: NORMAL (B相为0对高压三相三线制是正常的)
状态: 通过 ✅
```

### ✅ 测试2: 普通三相系统
```
输入: IA=100A, IB=0A, IC=95A, ModuleType=1
结果: THREE_PHASE_IMBALANCE
预期: THREE_PHASE_IMBALANCE (B相为0对普通系统是异常的)
状态: 通过 ✅
```

### ✅ 测试3: 基于功率的计算
```
输入: CurrentPower=750kW, RatedPower=1000kW
负荷率: 75%
结果: NORMAL
预期: NORMAL (75%负荷率是正常的)
状态: 通过 ✅
```

## 核心优势

1. **科学准确**: 基于负荷率百分比，符合电力行业标准
2. **智能识别**: 自动识别高压三相三线制设备，避免误判
3. **通用适用**: 适用于各种容量和类型的设备
4. **向下兼容**: 保持原有API接口不变
5. **降级策略**: 多层次的计算方法，确保系统稳定性

## 实际应用效果

- **消除误报**: 高压设备不再因B相为0被误判为"三相不平衡"
- **提高准确性**: 基于负荷率的判断更符合实际运行状态
- **增强可信度**: 减少误报，提高运维人员对系统的信任度
- **优化体验**: 更准确的设备状态显示，改善用户体验

## 部署说明

1. **数据库配置**: 确保 `tb_module.module_type = 4` 正确标识高压三相三线制设备
2. **系统重启**: 部署后重启应用服务器
3. **监控验证**: 观察高压设备的状态显示是否正常
4. **数据校验**: 对比部署前后的设备状态统计数据

## 总结

本次改进成功解决了高压三相三线制设备B相为0导致的误判问题，同时建立了更科学的负荷状态判断体系。系统现在能够：

- ✅ 正确识别高压三相三线制设备
- ✅ 准确判断各种设备的负荷状态
- ✅ 避免因接线方式差异导致的误报
- ✅ 提供更可靠的设备监控数据

改进后的系统更加智能化、准确化，为能源管理系统的稳定运行提供了有力保障。