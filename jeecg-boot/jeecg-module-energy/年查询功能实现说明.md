# 负荷监控年查询功能实现说明

## 📋 功能概述

根据您的需求，我已经成功修改了负荷监控接口，使其支持年查询功能。由于InfluxDB是按月分库存储的（每个月一个数据库），年查询需要跨多个月份的数据库进行查询。

## 🔧 核心修改内容

### 1. InfluxDBQueryBuilder 增强

**文件**: `jeecg-module-energy/src/main/java/org/jeecg/modules/energy/util/InfluxDBQueryBuilder.java`

**主要修改**:
- 增加了跨月查询支持
- 根据时间粒度自动选择查询策略
- 支持年查询的30天间隔聚合

**关键方法**:
```java
/**
 * 构建跨月查询的数据库列表
 */
public List<String> buildCrossMonthDatabases(String startTime, String endTime)

/**
 * 根据时间粒度获取间隔
 */
private String getTimeInterval(String granularity) {
    switch (granularity) {
        case "day": return "1h";    // 每小时
        case "month": return "1d";  // 每天
        case "year": return "30d";  // 每月（30天间隔）
        default: return "1h";
    }
}
```

### 2. RealtimeMonitorServiceImpl 增强

**文件**: `jeecg-module-energy/src/main/java/org/jeecg/modules/energy/service/impl/RealtimeMonitorServiceImpl.java`

**主要修改**:
- 新增跨月查询方法 `queryTimeSeriesDataCrossMonth()`
- 新增单月查询方法 `queryTimeSeriesDataSingleMonth()`
- 根据时间粒度自动选择查询策略
- 优化数据处理和时区转换

**关键方法**:
```java
/**
 * 跨月查询时序数据（用于年查询）
 */
private List<Map<String, Object>> queryTimeSeriesDataCrossMonth(
    List<String> moduleIds, List<Integer> parameters,
    String timeGranularity, String startTime, String endTime)

/**
 * 单月查询时序数据（用于日/月查询）
 */
private List<Map<String, Object>> queryTimeSeriesDataSingleMonth(
    List<String> moduleIds, List<Integer> parameters,
    String timeGranularity, String startTime, String endTime)
```

## 🗄️ 数据库结构说明

### InfluxDB 分库规则
- **数据库命名**: `hist202501`, `hist202502`, ..., `hist202512`
- **表名**: `hist`
- **tagname格式**: `MODULE_ID#字段名` (如: `YJ0001_1202#PP`)
- **字段说明**:
  - `time`: 时间戳（UTC时间）
  - `tagname`: 标签名（模块ID#参数名）
  - `value`: 数值
  - `status`: 状态

### 查询策略

#### 年查询（跨月）
```sql
-- 示例：查询2025年全年数据，需要查询12个数据库
-- 数据库：hist202501, hist202502, ..., hist202512

SELECT MEAN(value) as avg_value, MAX(value) as max_value, MIN(value) as min_value
FROM hist
WHERE (tagname = 'YJ0001_1202#PP' OR tagname = 'YJ0001_1203#PP')
  AND time >= '2025-01-01T00:00:00Z'
  AND time < '2025-02-01T00:00:00Z'
GROUP BY time(30d), tagname
ORDER BY time ASC
```

#### 月查询（单月）
```sql
-- 示例：查询2025年7月数据，只查询hist202507数据库
SELECT MEAN(value) as avg_value, MAX(value) as max_value, MIN(value) as min_value
FROM hist
WHERE (tagname = 'YJ0001_1202#PP' OR tagname = 'YJ0001_1203#PP')
  AND time >= '2025-07-01T00:00:00Z'
  AND time < '2025-08-01T00:00:00Z'
GROUP BY time(1d), tagname
ORDER BY time ASC
```

#### 日查询（单月）
```sql
-- 示例：查询2025年7月25日数据，只查询hist202507数据库
SELECT MEAN(value) as avg_value, MAX(value) as max_value, MIN(value) as min_value
FROM hist
WHERE (tagname = 'YJ0001_1202#PP' OR tagname = 'YJ0001_1203#PP')
  AND time >= '2025-07-25T00:00:00Z'
  AND time < '2025-07-26T00:00:00Z'
GROUP BY time(1h), tagname
ORDER BY time ASC
```

## 🎯 查询流程

### 年查询流程
1. **解析时间范围**: 从开始时间和结束时间确定需要查询的月份
2. **遍历月份**: 为每个月份构建单独的查询
3. **检查数据库**: 确认每个月份的数据库是否存在
4. **执行查询**: 对每个存在的数据库执行查询
5. **合并结果**: 将所有月份的查询结果合并
6. **数据处理**: 时区转换、负荷率计算、图表数据生成

### 关键代码示例
```java
// 计算需要查询的月份范围
YearMonth startYearMonth = YearMonth.from(startDate);
YearMonth endYearMonth = YearMonth.from(endDate);

// 遍历每个月份进行查询
for (YearMonth yearMonth = startYearMonth; 
     !yearMonth.isAfter(endYearMonth); 
     yearMonth = yearMonth.plusMonths(1)) {
    
    String dbName = influxDBConfig.getDatabaseName(
        yearMonth.getYear(), yearMonth.getMonthValue());
    
    // 检查数据库是否存在
    if (!influxDB.databaseExists(dbName)) {
        log.warn("数据库 {} 不存在，跳过", dbName);
        continue;
    }
    
    // 执行该月的查询
    QueryResult queryResult = influxDB.query(new Query(queryStr, dbName));
    List<Map<String, Object>> monthResults = InfluxDBUtil.parseQueryResult(queryResult);
    allResults.addAll(monthResults);
}
```

## 📊 数据处理

### 时区转换
- **存储**: InfluxDB中存储UTC时间
- **查询**: 前端传入北京时间，后端转换为UTC查询
- **显示**: 查询结果从UTC转换为北京时间显示

### 负荷率计算
```java
// 负荷率 = 有功功率 / 额定功率 × 100%
double loadRate = (currentPower / ratedPower) * 100;
```

### 时间标签格式化
- **日查询**: `HH:mm` (如: 14:30)
- **月查询**: `MM-dd` (如: 07-25)
- **年查询**: `yyyy-MM` (如: 2025-07)

## 🧪 测试验证

### 测试文件
- `负荷监控年查询测试.http` - 包含完整的年查询测试用例

### 测试场景
1. **日查询**: 24个数据点（每小时）
2. **月查询**: 30-31个数据点（每天）
3. **年查询**: 12个数据点（每月）

### 预期结果
```json
{
    "success": true,
    "message": "查询成功",
    "result": {
        "powerChartData": {
            "title": "有功功率",
            "timeLabels": ["2025-01", "2025-02", ..., "2025-12"],
            "series": [...]
        },
        "loadRateChartData": {
            "title": "负荷率",
            "timeLabels": ["2025-01", "2025-02", ..., "2025-12"],
            "series": [...]
        },
        "summary": {
            "totalDataPoints": 24,
            "granularity": "每月",
            "moduleCount": 2,
            "dataType": "负荷监控数据"
        }
    }
}
```

## ✅ 功能特性

### 1. 自动数据库选择
- 根据查询时间范围自动确定需要查询的数据库
- 跳过不存在的数据库，避免查询错误
- 支持跨年查询（如果需要）

### 2. 智能查询策略
- **日/月查询**: 使用单月查询，性能更好
- **年查询**: 使用跨月查询，数据完整

### 3. 数据完整性保证
- 合并多个月份的查询结果
- 处理缺失数据（显示为null）
- 保持时间序列的连续性

### 4. 性能优化
- 只查询存在的数据库
- 使用适当的时间聚合间隔
- 避免不必要的数据传输

## 🚀 使用说明

### 前端调用示例
```javascript
// 年查询
const yearQuery = {
    moduleIds: ["yj0001_1202", "yj0001_1203"],
    timeGranularity: "year",
    queryDate: "2025-01-01",
    startTime: "2025-01-01 00:00:00",
    endTime: "2025-12-31 23:59:59"
};

const response = await api.post('/energy/realtime/getLoadTimeSeriesData', yearQuery);
```

### 注意事项
1. **数据库命名**: 确保InfluxDB数据库按照 `hist{YYYY}{MM}` 格式命名
2. **tagname格式**: 确保tagname格式为 `MODULE_ID#字段名`
3. **时区处理**: 前端传入北京时间，后端自动处理时区转换
4. **性能考虑**: 年查询可能涉及大量数据，建议适当设置超时时间

## 🎉 总结

本次修改成功实现了负荷监控的年查询功能，主要特点：

1. **完整支持**: 支持日/月/年三种时间粒度的查询
2. **跨月查询**: 年查询自动跨多个月份数据库
3. **数据完整**: 合并所有相关数据库的查询结果
4. **性能优化**: 根据查询类型选择最优策略
5. **兼容性好**: 保持原有接口不变，新增功能透明

您现在可以使用年查询功能来查看设备全年的负荷变化趋势，每月一个数据点，便于分析长期的负荷模式。