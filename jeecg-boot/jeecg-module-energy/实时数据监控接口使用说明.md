# 实时数据监控接口使用说明

## 📋 功能概述

实时数据监控模块提供了完整的能源数据实时监控功能，支持：

- 🌳 **维度树选择**：根据维度获取对应的仪表列表
- ⚙️ **参数配置**：获取不同能源类型的可选参数
- 📊 **时序数据查询**：支持日/月/年不同时间粒度的数据查询
- 🔄 **实时状态监控**：获取仪表的当前状态和最新数值

## 🚀 接口列表

### 1. 根据维度获取仪表列表

**接口地址**：`GET /energy/realtime/getModulesByDimension`

**参数**：
- `dimensionCode`：维度编码（必填）
- `energyType`：能源类型（必填，1:电力,2:天然气,3:压缩空气,4:企业用水）
- `includeChildren`：是否包含子维度（可选，默认true）

**示例**：
```
GET /energy/realtime/getModulesByDimension?dimensionCode=A02A02A01&energyType=1&includeChildren=true
```

### 2. 获取参数配置

**接口地址**：`GET /energy/realtime/getParameterConfig`

**参数**：
- `energyType`：能源类型（必填，1:电力,2:天然气,3:压缩空气,4:企业用水）

**示例**：
```
GET /energy/realtime/getParameterConfig?energyType=1
```

### 3. 查询时序数据（核心接口）

**接口地址**：`POST /energy/realtime/getTimeSeriesData`

**请求体**：
```json
{
    "moduleIds": ["yj0001_13", "yj0001_14"],
    "parameters": [1, 2, 7],
    "timeGranularity": "day",
    "queryDate": "2025-07-25"
}
```

**时间粒度说明**：
- `day`：查询指定日期的24小时数据，每小时一个数据点
- `month`：查询指定月份的数据，每天一个数据点
- `year`：查询指定年份的数据，每月一个数据点

### 4. 获取实时状态

**接口地址**：`POST /energy/realtime/getCurrentStatus`

**请求体**：
```json
{
    "moduleIds": ["yj0001_13", "yj0001_14"],
    "parameters": [1, 2, 7]
}
```

## 🧪 测试接口

为了方便测试，提供了以下测试接口：

- `GET /energy/realtime/test/testGetModules` - 测试获取仪表列表
- `GET /energy/realtime/test/testGetParameters` - 测试获取参数配置
- `GET /energy/realtime/test/testGetTimeSeriesData` - 测试查询时序数据
- `GET /energy/realtime/test/testGetCurrentStatus` - 测试获取实时状态

## 📊 参数编码说明

### 电力参数（energyType=1）
- 1：A相电流（A）
- 2：B相电流（A）
- 3：C相电流（A）
- 4：A相电压（V）
- 5：B相电压（V）
- 6：C相电压（V）
- 7：总有功功率（kW）
- 8：总无功功率（kVar）
- 9：总视在功率（kVA）
- 10：总功率因数
- 11：频率（Hz）
- 12：正向有功总电能（kWh）

### 其他能源参数（energyType=2,3,4）
- 20：温度（℃）
- 21：压力（MPa）
- 22：瞬时流量（m³/h）
- 23：累计值（m³）

## 🔧 前端集成示例

### 1. 获取仪表列表
```javascript
// 当维度树节点被选中时
onDimensionSelect(dimensionCode) {
    const params = {
        dimensionCode: dimensionCode,
        energyType: 1, // 电力
        includeChildren: true
    };
    
    axios.get('/energy/realtime/getModulesByDimension', { params })
        .then(response => {
            if (response.data.success) {
                this.moduleList = response.data.result;
                // 更新仪表下拉选择器
                this.updateModuleSelector();
            }
        });
}
```

### 2. 查询时序数据
```javascript
// 查询时序数据
queryTimeSeriesData() {
    const query = {
        moduleIds: this.selectedModuleIds,
        parameters: this.selectedParameters,
        timeGranularity: this.timeGranularity,
        queryDate: this.queryDate
    };
    
    axios.post('/energy/realtime/getTimeSeriesData', query)
        .then(response => {
            if (response.data.success) {
                const result = response.data.result;
                // 更新图表
                this.updateChart(result.chartData);
                // 更新表格
                this.updateTable(result.tableData);
            }
        });
}
```

### 3. ECharts图表配置
```javascript
updateChart(chartData) {
    const option = {
        title: {
            text: '实时数据监控',
            left: 'center'
        },
        tooltip: {
            trigger: 'axis',
            axisPointer: {
                type: 'cross'
            }
        },
        legend: {
            data: chartData.series.map(s => `${s.moduleName}/${s.paramName}`),
            top: 30
        },
        xAxis: {
            type: 'category',
            data: chartData.timeLabels
        },
        yAxis: {
            type: 'value'
        },
        series: chartData.series.map(s => ({
            name: `${s.moduleName}/${s.paramName}`,
            type: 'line',
            data: s.data,
            itemStyle: {
                color: s.color
            }
        }))
    };
    
    this.chart.setOption(option);
}
```

## 📝 注意事项

1. **时区处理**：InfluxDB存储UTC时间，接口会自动转换为北京时间显示
2. **数据完整性**：缺失的数据点会显示为null，前端需要适当处理
3. **性能优化**：建议对实时数据进行适当的缓存
4. **错误处理**：接口返回统一的错误格式，前端需要处理异常情况

## 🔍 故障排查

1. **仪表列表为空**：
   - 检查维度编码是否正确
   - 确认该维度下是否有对应能源类型的仪表
   - 检查仪表的isaction字段是否为'Y'

2. **时序数据查询失败**：
   - 检查InfluxDB连接是否正常
   - 确认tagname格式是否正确（模块ID#参数字段）
   - 检查时间范围是否合理

3. **实时状态显示离线**：
   - 检查最后更新时间是否在5分钟内
   - 确认实时数据表中是否有对应仪表的数据

## 📚 相关文档

- [JeecgBoot开发文档](http://help.jeecg.com/java/)
- [Swagger接口文档](http://localhost:8080/jeecg-boot/doc.html)
- [InfluxDB查询语法](https://docs.influxdata.com/influxdb/v1.8/query_language/)
