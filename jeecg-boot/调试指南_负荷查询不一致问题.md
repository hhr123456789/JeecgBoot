# 负荷查询数据不一致问题调试指南

## 🚨 当前问题
网页查询和Excel导出的数据仍然不一致：
- **网页显示**：最大功率 `44.9` @ `2025-07`
- **Excel导出**：最大功率 `7.5` @ `2025-07-12 18:50:21`

## 🔍 可能的原因

### 1. 时间参数不一致
**网页查询**使用：
```json
{
  "timeType": "day",
  "startTime": "2025-07-12 00:00:00", 
  "endTime": "2025-07-12 23:59:59"
}
```

**Excel导出**使用：
```json
{
  "timeGranularity": "day",
  "queryDate": "2025-07-12"
}
```
然后通过 `buildTimeRange()` 构建时间范围。

### 2. 仪表ID不一致
检查网页和Excel是否查询了相同的仪表ID列表。

### 3. 数据库选择不同
不同的时间范围可能导致查询不同的月份数据库。

## 🔧 调试步骤

### 步骤1：检查日志输出
启动应用后，执行相同的查询，观察日志：

```bash
# 查看应用日志
tail -f logs/jeecg-boot.log | grep -E "(DEBUG|📋|🔍|📊)"
```

**关键日志信息**：
1. `📋 Excel导出查询参数` - 检查Excel的查询参数
2. `🔍 DEBUG - 调用来源追踪` - 确认调用路径
3. `📊 查询详情` - 对比网页和Excel的查询参数
4. `🔍 DEBUG - 查询参数详情` - 检查moduleIds、时间范围
5. `📊 获取到 X 条原始数据` - 对比数据量

### 步骤2：使用测试文件验证
使用 `DEBUG_负荷查询参数对比测试.http` 文件：

1. 先执行网页查询测试
2. 再执行Excel导出测试  
3. 对比两次查询的日志输出

### 步骤3：检查关键差异点

#### A. 时间范围对比
```
网页查询：startTime=2025-07-12 00:00:00, endTime=2025-07-12 23:59:59
Excel导出：buildTimeRange生成的时间范围
```

#### B. 数据库选择对比
```
网页查询：使用的数据库名称
Excel导出：使用的数据库名称
```

#### C. 原始数据量对比
```
网页查询：获取到 X 条原始数据
Excel导出：获取到 Y 条原始数据
```

#### D. 仪表数据对比
```
网页查询：仪表 yj0001_1202 前3条数据样例
Excel导出：仪表 yj0001_1202 前3条数据样例
```

## 🎯 预期发现

### 如果时间范围不同
- 修复 `buildTimeRange` 方法
- 或统一使用相同的时间参数格式

### 如果数据库不同
- 检查 `getDatabaseNameByTimeRange` 方法
- 确保相同时间范围选择相同数据库

### 如果原始数据不同
- 检查 InfluxDB 查询语句
- 检查 tagname 构建逻辑

### 如果数据处理不同
- 检查统计计算逻辑
- 检查时间转换逻辑

## 🚀 快速测试命令

```bash
# 1. 测试网页查询
curl -X POST "http://localhost:8080/energy/realtime/getLoadTableData" \
  -H "Content-Type: application/json" \
  -d '{
    "moduleIds": ["yj0001_1202"],
    "timeType": "day", 
    "startTime": "2025-07-12 00:00:00",
    "endTime": "2025-07-12 23:59:59"
  }'

# 2. 测试Excel导出（查看日志，不下载文件）
curl -X POST "http://localhost:8080/energy/realtime/exportLoadData" \
  -H "Content-Type: application/json" \
  -d '{
    "fileName": "test",
    "moduleIds": ["yj0001_1202"],
    "queryDate": "2025-07-12",
    "timeGranularity": "day"
  }' \
  --output /dev/null
```

## 📝 记录发现
请将调试过程中发现的关键信息记录在这里：

- [ ] 时间参数是否一致：
- [ ] 数据库选择是否一致：
- [ ] 原始数据量是否一致：
- [ ] 统计结果是否一致：
