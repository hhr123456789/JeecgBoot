# 负荷查询逻辑统一修改备份

## 修改时间
2025-08-09

## 修改原因
解决网页查询和Excel导出数据不一致的问题：
- 网页查询使用聚合查询，无法获得准确的最大/最小功率发生时间
- Excel导出使用原始数据查询，能够获得精确的时间信息
- 统一使用原始数据查询策略，确保数据一致性

## 修改内容

### 1. 统一查询策略选择逻辑
**文件**: `RealtimeMonitorServiceImpl.java`
**位置**: 第730-737行

**修改前**:
```java
// ✨ 关键优化：根据时间类型智能选择查询策略
if ("year".equals(query.getTimeType())) {
    log.info("🗓️ 年查询使用跨月查询策略");
    return processLoadTableFromTimeSeriesData(query, modules);
} else {
    log.info("📅 日/月查询使用单月查询策略");
    return processLoadTableFromSingleQuery(query, modules);
}
```

**修改后**:
```java
// ✨ 统一使用原始数据查询策略（确保时间精度和数据准确性）
log.info("🔍 统一使用原始数据查询策略，timeType: {}", query.getTimeType());
return processLoadTableFromTimeSeriesData(query, modules);
```

### 2. 备份原有方法
**文件**: `RealtimeMonitorServiceImpl.java`
**位置**: 第745行

**修改前**:
```java
private LoadTableResultVO processLoadTableFromSingleQuery(LoadTableQueryVO query, List<TbModule> modules) {
```

**修改后**:
```java
@Deprecated
private LoadTableResultVO processLoadTableFromSingleQuery_BACKUP(LoadTableQueryVO query, List<TbModule> modules) {
```

### 3. 更新方法注释
**文件**: `RealtimeMonitorServiceImpl.java`

**processLoadTableFromTimeSeriesData方法**:
- 修改前: "跨月查询处理统计数据（使用原始数据查询）"
- 修改后: "统一的原始数据查询处理（适用于日/月/年查询）"

**queryRawDataCrossMonth方法**:
- 修改前: "跨月查询原始数据（用于统计分析，保留精确时间）"
- 修改后: "智能原始数据查询（适用于日/月/年查询，自动跨月处理）"

## 预期效果
1. 网页查询和Excel导出将使用相同的查询逻辑
2. 所有查询都能获得准确的最大/最小功率发生时间
3. 数据一致性得到保证
4. 支持跨月查询，适用于所有时间范围

## 回滚方案
如需回滚，执行以下步骤：
1. 恢复第730-737行的条件判断逻辑
2. 将 `processLoadTableFromSingleQuery_BACKUP` 重命名为 `processLoadTableFromSingleQuery`
3. 恢复原有的方法注释

## 测试建议
1. 测试日查询：选择单天时间范围
2. 测试月查询：选择单月时间范围
3. 测试年查询：选择跨年时间范围
4. 对比网页显示和Excel导出的数据一致性
5. 验证最大/最小功率发生时间的准确性
